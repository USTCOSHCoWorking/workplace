# 分布式包分发网络

## 简介

这是一个用于进行包分发的分布式文件系统（以下简称X），它的设计初衷是替代镜像源，达到自动同步/高可用性/无需维护的效果。使用者在从X中获取软件包时，也会作为节点向其他用户提供下载服务，同时在使用过程中对X上的软件包版本进行更新，当然，这一过程是自动完成/对用户隐藏的。

## 特点

### 1.审核

为了保证X网络整体的平等性，X不应有任何中心服务器或高级服务器，同步官方源和X的工作将由使用者完成。[审核机制](#1.node)确保了在少数用户试图"欺骗"X网络时，该网络具有一定的能力辨认并排除这些操作。

_注：像区块链一样，使用这种做法仍然会对[51%攻击](https://en.bitcoin.it/wiki/Majority_attack)极为敏感_

### 2.标记

考虑到和目前分布式文件系统的差异性，我们的文件系统只需储存软件包，而且大多数软件包下载到本地之后就不再进行修改而只是被调用，除去每各节点分配的固定储存区域以外，我们可以对本机进行搜索，并将文件hash与X网络中数据比对，记录可以作为源的软件包。当有对其需求时，直接从本机安装位置共享文件。

### 3.加入网络

为了保证X网络整体的平等性，故X不能像目前的BT/IPFS那样设定硬编码的bootstrap服务器用于获得第一批节点，故我们考虑借用BT网络和其bootstrap服务器用于获取初始节点并加入X网络。具体参见[此处](#0.node初始化)。

## 优势

### 1.相比普通镜像源的优势

去中心化：

> 软件包被分散储存在分布式网络的各个节点上，能够保证24小时100%的可用性，不会因为服务器故障或日常维护而临时不可用。

下载速度：

> 下载软件包时，可以同时从多个节点获取同一个包，即从原理上能获得数倍的下载速度。

无需维护：

> 整个分布式网络的更新同步完全由用户的上传完成，完全不需要人为干预。

多版本：

> 软件包永久储存，即使是因为官方放弃维护的旧版本软件包，也可以从这个网络中获取。

### 1.相比bt的优势

长时效：

> 该网络能够保证所有被储存的软件包永久被储存且在多个节点中有足够的备份，不会像bt网络存在一定时效性，需求量较少的资源下载难度会提高。

### 2.相比ipfs的优势

安全性：

> 采用审核机制，可以驳回用户的错误上传请求，以此维护整个网络的稳定。

## 工作方式

### 0.node初始化

工作流0：

1. 主机下载并安装X网络客户端
2. 配置X客户端，提供至少1G的空间用作节点储存
3. 接入BT网络
4. 查询索引文件并更新到最新版本，下载到本地并获得提供这份文件的主机ip作为初始节点
5. 在BT上做种分享索引文件
6. 向初始节点询问其附近节点，访问新节点并确定距离，用可达的更近节点替代初始节点
7. 重复e，直到没有更近的节点

### 1.node

主要的工作模式，将本机作为一个节点运行X网络，也可以从网络中

例如【从pip下载numpy (1.14.2)】



__if X网络上没有numpy 或 X网络上的numpy版本更低(1.13.1)__

工作流1：

1. 从BT网络更新索引文件和可用节点(如果本地储存的所有节点均不可达，否则只需更新索引文件)

2. 调用pip search检查出发现pypi上numpy已更新到1.14.2，但索引文件上numpy为1.13.1

3. 调用pip install从pip安装numpy (1.14.2)

4. 计算软件包hash并和更新通知给本地可达的所有节点

5. 接收到更新通知的节点继续将该信息传给其他节点，并通过pypi验证

6. 验证成功的节点会新建并在BT网络上做种一个更新后的索引文件（仅记录被更新的软件包及版本），验证失败的节点会新建并在BT网络上做种一个错误日志，作为验证的报告

7. 所有被通知节点均会实时监控两类文件的种子数，当其中一种达到预设的阈值时，如果【验证成功】，新的验证文件成为正式验证文件（注意旧索引仍被保存在BT网络上），部分机器从pip安装numpy的片段作为本地缓存，并向所有节点发送通知。如果【验证失败】，移除f中产生的文件，并向发起者发送通知。

   ​

__if X网络上有最新版本的numpy(1.14.2)__

工作流2：

1. 从BT网络更新索引文件和可用节点(如果本地储存的所有节点均不可达，否则只需更新索引文件)
2. 调用pip search检查出发现pypi上numpy与X网络版本一致，或__pypi不可达__
3. 向初始节点A询问numpy(1.14.2)，A会向A保存的节点递归询问直到有结果，再将结果返回给询问者。A会在临时文件中储存软件包信息和拥有者避免下次同样请求。若A有其中一部分，建立连接传输。
4. 向返回的所有拥有者发送信息请求连接并下载所需软件包





### 2.source

此模式一般用于内网进行指定软件包集合的分发。source模式运行在主-从体系中的主机（需要连接外网）上，该模式需要指定一个requirement文件，然后会从X网络下载并打包requirement文件中指定的软件包和相应版本。此后，从主机可以获取打包过的任何一个软件包。

### 3.client

此模式一般用于内网进行指定软件包集合的分发。source模式运行在主-从体系中的从机（无需连接外网）上，该模式需要指定一个主机地址，然后会从主机下载指定或所有的软件包。不同从机下载顺序不同，并可以在下载好部分软件包后在从机中互相传输剩余软件包。